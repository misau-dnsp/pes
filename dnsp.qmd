---
title: "Plano Económico Social 2026"
subtitle: "Direcção Nacional de Saúde Pública (MISAU)"
execute:
  echo: false
  warning: false
---

```{r, results='hide'}
library(tidyverse)
library(ggthemes)
library(robotoolbox)
library(glamr)
library(dm)
library(haven)
library(gt)
library(glue)

acct_kobo <- "kobo-jlara"
acct_kobo_con <- get_account(name = acct_kobo)

kobo_token(username = acct_kobo_con$username,
           password = acct_kobo_con$password,
           url = acct_kobo_con$url)
```

```{r load-kobo-data}
assets <- kobo_asset_list()

uid <- assets %>%
  filter(name == "2026 DNSP PES") %>%
  pull(uid) %>%
  first()

asset_list <- kobo_asset(uid)

asset_df <- kobo_submissions(asset_list)

```


```{r munge-data}

columns_to_label <- c("responsavel_programa", "responsavel_pf_ma", "subactividade_tipo", "objectivo_especifico", "objectivo_pess")


df_main <- asset_df$main %>% 
  mutate(across(all_of(columns_to_label), as_factor))

n_activities <- nrow(df_main)

type_activities <- df_main %>% 
  count(subactividade_tipo, name = "n")

df_tbl_dates <- asset_df$tbl_datas_impl

df_gantt <- asset_df %>%
  dm_flatten_to_tbl(.start = tbl_datas_impl,
                    .join = left_join) %>% 
  select(
    responsavel_programa,
    subactividade_tipo,
    subactividade_descricao,
    subactividade_data_inicio,
    subactividade_data_fim
  ) %>% 
mutate(
  responsavel_programa = str_to_upper(responsavel_programa),
  data_inicio = subactividade_data_inicio,
  subactividade_descricao_short = subactividade_descricao |> 
    str_trunc(width = 100, ellipsis = "...") |> 
    str_wrap(width = 50),
  subactividade_descricao_short = factor(subactividade_descricao_short, levels = unique(subactividade_descricao_short))
  ) %>% 
  pivot_longer(
    cols = contains("_data_"),
    names_to = "data_tipo",
    values_to = "data"
  ) %>% 
  arrange(responsavel_programa, desc(data_inicio)) %>%
  mutate(
    subactividade_descricao_short = factor(
      subactividade_descricao_short,
      levels = unique(subactividade_descricao_short)
    )
  )
```

# Sumário Executivo

Como parte do Plano Económico e Social (PES) do ano 2026, a Direcção Nacional de Saúde Pública (DNSP) está a introduzir novas tecnologias para a recolha, análise e monitoria da execução das actividades planificadas. A intenção é de automatizar a gestão dos dados PES e, desta forma, melhorar a planificação e execução em si. Até à data de criação do presente relatório, o pessoal do programa DNSP apresentou informações para um total de `r n_activities` subactividades.

```{r plot-type-table}
type_activities %>%
  gt() %>%
  
  # Column names
  cols_label(
    subactividade_tipo = "Tipo de Subactividade",
    n = "Número"
  ) %>%

  # Column widths
  cols_width(
    subactividade_tipo ~ px(500),
    n ~ px(200)
  ) %>%

  # General table options
  tab_options(
    table.font.names = c("Nunito Sans", "sans-serif"),
    table.align = "left"
  ) %>%

  # Style for column headers (small, bold)
  tab_style(
    style = cell_text(size = px(14), weight = "bold", align = "left"),
    locations = cells_column_labels()
  ) %>%

  # Body text style
  tab_style(
    style = cell_text(color = "#1C2826", align = "left", size = px(14)),
    locations = cells_body()
  ) %>%

  # Center-align the "n" column
  tab_style(
    style = cell_text(align = "center"),
    locations = cells_body(columns = n)
  )

```

A fim de monitorar a execução atempada das actividades planificadas ao longo de 2026, a equipa de M&A da UMA criou uma diagrama Gantt que os gestores de programas e a direcção podem utilizar para verificar o estado das actividades.  Esta visualização será actualizada cada mes ou trimestre (periodicadade por defenir) com base nas informações fornecidas pelos responsáveis de M&A da área do programa em ligação com a UMA

```{r plot-activity-gantt, fig.width=12, fig.align='center', fig.bg="transparent"}

# plot activity gantt chart
df_gantt_plot <- ggplot(df_gantt) +
  geom_line(
    aes(x = subactividade_descricao_short, y = data, color = responsavel_programa),
    linewidth = 4,
    lineend = "butt",
    linejoin = "mitre"
  ) +
  scale_y_date(
    date_breaks = "1 month",
    date_labels = "%m-%Y"
  ) +
  coord_flip() +
  facet_wrap(~ responsavel_programa, ncol = 1, scales = "free_y") +
  theme_fivethirtyeight() +
  labs(
    title = "Cronograma de Actividades PES 2026 (DNSP)",
    caption = "Fonte: KoboToolbox, DNSP 2026 PES",
    x = NULL,
    y = "Date"
  ) +
  theme(
    plot.title = element_text(size = 15, face = "bold.italic", hjust = 0),
    plot.caption = element_text(margin = margin(t = 10), size = 12, hjust = 1, face = "italic"),
    legend.position = "none",
    axis.text.x = element_text(size = 13, angle = 45, hjust = 1),
    axis.text.y = element_text(size = 13),
    panel.spacing = unit(0.5, "lines"),
    panel.grid.minor.x = element_blank(),
    strip.background = element_rect(fill = "grey90", color = "grey20"),
    strip.text = element_text(color = "grey20", 
                              face = "bold", 
                              size = 11,
                              margin = margin(t = 3, b = 3)
    )
  )

df_gantt_plot
```
